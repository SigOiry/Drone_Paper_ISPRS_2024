---
title: "DRAFT -- Exploring diverse Applications of Drone Technology: From Active to Passive  Remote Sensing  -- DRAFT"
author:
  - name: Simon Oiry
    orcid: 0000-0001-7161-5246
    corresponding: true
    email: oirysimon@gmail.com
    roles:
      - Investigation
      - Writing
      - Data acquisition
    affiliations:
      - Institut des Substances et Organismes de la Mer, ISOMer, Nantes Université, UR 2160, F-44000 Nantes, France
  - name: Philippe Rosa
    corresponding: false
    roles: 
      - Data acquisition
      - Revision
    affiliations:
      - Institut des Substances et Organismes de la Mer, ISOMer, Nantes Université, UR 2160, F-44000 Nantes, France
  - name: Laurent Barillé
    corresponding: false
    roles: 
      - Investigation
      - Data acquisition
      - Revision
    affiliations:
      - Institut des Substances et Organismes de la Mer, ISOMer, Nantes Université, UR 2160, F-44000 Nantes, France
keywords:
  - Drone
  - Remote Sensing
  - Coastal Ecosystems
  - Archeology
  - LiDAR
abstract: |
  coucou
plain-language-summary: 
key-points:
  - A review of drone technologies applied to coastal ecology, 
date: last-modified
citation:
  container-title: Journal of photogrammetry and Remote Sensing
number-sections: true
notebook-links: false
editor_options: 
  chunk_output_type: console
csl: RSE.csl
---

```{r library}
#| cache: false
#| echo: false
#| warning: false
#| eval: true

library(terra)
library(sf) 
library(rnaturalearth) 
library(rnaturalearthdata) 
library(rnaturalearthhires)
library(tidyverse)
library(Utilities.Package)
library(patchwork)
library(tidyterra)
library(ggmap)
library(sf)

```

```{r my_comma}
#| cache: false
#| echo: false
#| warning: false

my_comma<-scales::label_comma(accuracy = NULL, big.mark = ",",decimal.mark = ".")
```

## Site study

```{r Figure1 Overall Map}
#| cache: true
#| echo: false
#| eval: false
#| warning: false

world_map <- sovereignty10 %>% 
  st_as_sf()

bbox_europe <- st_bbox(c(xmin = -20, ymin = 34,
                         xmax = 30, ymax = 55) ,
                       crs = st_crs(world_map)) 

world_map<-st_make_valid(world_map) 

european_union_country <- st_crop(world_map, bbox_europe)  %>% 
  st_transform("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs ") %>% 
  dplyr::pull(unique(SOVEREIGNT))


european_union_map_cropped <- sovereignty10 %>% 
  st_as_sf() %>% 
  dplyr::filter(SOVEREIGNT %in% european_union_country)

Projects<-data.frame(
  Name=c(
  "Spain - Guadalquivir River",
  "Spain - Baiona",
  "France - Noirmoutier Island",
  "Greece - Cape Tainaron"),
  Long=c(-6.23104,
         -8.86272, 
         -2.16741,
         22.486823) ,
  Lat=c(36.8947, 
        42.120795,
        46.9076,
        36.401765) 
  )  %>% 
  st_as_sf(coords=c("Long","Lat") )  %>% 
  st_set_crs("EPSG:4326")  %>% 
  st_transform("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs ")  

Projects_df<-Projects %>%
  dplyr::mutate(lon = sf::st_coordinates(.) [,1],
                lat = sf::st_coordinates(.) [,2]) %>% 
  sf::st_set_geometry(NULL)  %>% 
  tidyr::separate(Name, into=c("Country","Site") ,sep=" - ")  %>% 
  dplyr::mutate(Country=as.factor(Country) ,
                Site=as.factor(Site) ) 

sf_use_s2(FALSE)

bbox_EU <- st_bbox(c(xmin = -30, ymin = 20,
                         xmax = 50, ymax = 70) ,
                       crs = st_crs(european_union_map_cropped) ) 

  MiniEU_map<-st_crop(european_union_map_cropped, bbox_EU)  %>% 
  st_transform("+proj=laea +lat_0=52 +lon_0=10 +x_0=4321000 +y_0=3210000 +ellps=GRS80 +units=m +no_defs ")  

  df_P1<-Projects_df %>% 
    dplyr::mutate(ID = c(1:nrow(.)),
           ID = case_when(ID == 1 ~ "C",
                          ID == 2 ~ "B",
                          ID == 3 ~ "A",
                          TRUE ~ "D")) %>% 
    dplyr::select(c(lon,lat,ID,Site))
    
    scaleFUN <- function(x) paste0(sprintf("%.2f", x),"°N")
  

p1 <-
  ggplot(MiniEU_map) +
  geom_sf(linewidth=0.5,alpha=0.93,
          fill="#CFCFCF",colour="grey30")+
  coord_sf(xlim=c(2600000,5600000) ,
          ylim=c(1600000,3100000))+
    ggforce::geom_mark_ellipse(data=df_P1,
                 aes(x=lon,
                     y=lat,
                     label = ID,
                     description=Site) ,
                 linewidth=0.2,
                 fill="goldenrod",
                 show.legend=F,
                 label.hjust = 0.5,
                 con.size = 1,
                 con.colour = "goldenrod4",
                 label.fontsize = c(20,15),
                 alpha=0.8,
  expand = unit(2, "mm") , 
  radius = unit(2, "mm") , 
  label.buffer = unit(5, "mm") ,
  label.fill = "grey90")+

  theme_Bede_Map()+
  labs(x="Longitude",
       y="Latitude")+
  scale_y_continuous(labels=scaleFUN)+
  theme(plot.margin = margin(t = 0.1, r = 2, b = 0.1, l = 0.1, "cm"),
        axis.title = element_blank(),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        # panel.background = element_rect(fill = "white"),
        plot.background = element_rect(fill = "white"))



ggsave("Figures/High_res/Figure1/Map_Study_Site.tiff",p1,width= 10, height=5)  


```

```{r Figure1 Noirmoutier}
#| cache: true
#| echo: false
#| eval: false
#| warning: false


masks_Noirmoutier <- "Data/shp/Figure1/Noirmoutier_masks_32630.shp"%>% 
  read_sf()

Flight_Noirmoutier <- "Data/shp/Figure1/Noirmoutier_flight_area_32630.shp"%>% 
  read_sf()

img_Noirmoutier <- rast("Data/S2_images/Noirmoutier.tiff")

sf_france <- read_sf("Data/shp/Figure1/world-administrative-boundaries.shp") %>% 
  dplyr::filter(name == "France") %>% 
  ggplot()+
  geom_sf()+
  geom_point(aes(x = -2.13494, y = 46.93734), size = 5, color = "red")+
  theme_void()

BB_img <- ggplot()+
  geom_spatraster_rgb(data = rast("Data/Pictures/Polychaete_Reef_cropped.png"))+
  coord_equal()+
  theme_void()+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=5),
        panel.spacing = unit(0, "cm"),
        plot.margin = margin(0, 0, 0, 0, "cm"))

BB_segm <- data.frame(x = c(562411.2,558511,562732.1,558411),
                      y = c(5195061.5,5199150,5194521.8,5191521), 
                      group = c(1,1,2,2))
# 
# Flight_label<-data.frame(
#   Name=c(
#   "Noirmoutier Island") ,
#   Description = c("Multispectral - LiDAR"),
#   Long=c(-2.17503) ,
#   Lat=c(46.90546) 
#   )  %>% 
#   st_as_sf(coords=c("Long","Lat") )  %>% 
#   st_set_crs("EPSG:4326")  %>% 
#   st_transform(crs(masks_Noirmoutier))  %>% 
#   dplyr::mutate(lon = sf::st_coordinates(.) [,1],
#                 lat = sf::st_coordinates(.) [,2]) %>% 
#   sf::st_set_geometry(NULL)


xmin_noirm = 551000
xmax_noirm = 569800
ymin_noirm = 5191700
ymax_noirm = 5210500
  
plot_label_Noirmoutier <- data.frame(x = xmin_noirm+((xmax_noirm-xmin_noirm)*0.05),
                         y = 5210500-((5210500-ymin_noirm)*0.05)) %>%
  st_as_sf(coords=c("x","y")) %>%
  st_set_crs(crs(masks_Noirmoutier)) %>%
  st_coordinates()

thumb_France<-data.frame(x = c(xmin_noirm+((xmax_noirm-xmin_noirm)*0.8), xmin_noirm+((xmax_noirm-xmin_noirm)*1.05)),
                                   y = c(ymin_noirm+((ymax_noirm-ymin_noirm)*0.8), ymin_noirm+((ymax_noirm-ymin_noirm)*1.05))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Noirmoutier)) %>% 
  st_coordinates()

grob_img_Noirmoutier <- data.frame(x = c(xmin_noirm-((xmax_noirm-xmin_noirm)*0.01), xmin_noirm+((xmax_noirm-xmin_noirm)*0.40)),
                                   y = c(ymin_noirm-((ymax_noirm-ymin_noirm)*0.01), ymin_noirm+((ymax_noirm-ymin_noirm)*0.40))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Noirmoutier)) %>% 
  st_coordinates()

Noirmoutier_plot <-
ggplot() +
  scale_fill_manual("", labels = c("Flight area","Intertidal area", "Land area"),
                    values = c("red","#7DC27D", "#CFCFCF"))+
  geom_spatraster_rgb(data = img_Noirmoutier,max_col_value = 0.6)+
  annotation_custom(ggplotGrob(BB_img),xmin = as.numeric(grob_img_Noirmoutier[1,1]), xmax = as.numeric(grob_img_Noirmoutier[2,1]), ymin = as.numeric(grob_img_Noirmoutier[1,2]),ymax = as.numeric(grob_img_Noirmoutier[2,2]))+
  annotation_custom(ggplotGrob(sf_france),xmin = as.numeric(thumb_France[1,1]), xmax = as.numeric(thumb_France[2,1]), ymin = as.numeric(thumb_France[1,2]),ymax = as.numeric(thumb_France[2,2]))+

  # geom_sf(data = masks_Noirmoutier, mapping = aes(fill = Type),linewidth=0.05,alpha=0.93,colour="grey30")+
  geom_sf(data = Flight_Noirmoutier, mapping = aes(fill = Type),linewidth=0.05,alpha=0.80)+
  geom_line(data = BB_segm, aes(x = x, y=y, group = group), linewidth = 1, linetype = "dashed")+
  geom_label(aes(x = 555200, y =5204500, label = "Noirmoutier Island"), fill = "white", alpha = 0.3, size = 6)+
      coord_sf(xlim=c(xmin_noirm,xmax_noirm),
               ylim=c(5191700,ymax_noirm))+
  # ggforce::geom_mark_ellipse(data=Flight_label,
  #                aes(x=lon,
  #                    y=lat,
  #                    label = Name,
  #                    group = Name,
  #                    description=Description),
  #                size=0.3,
  #                fill = "goldenrod",
  #                con.colour = "goldenrod4",
  #                show.legend=F,
  #                label.fontsize = 25,
  #                label.hjust = 0.5,
  #                con.size = 2,
  #                label.width = 100,
  #                alpha=0.8,
  # expand = unit(2, "mm") , 
  # radius = unit(2, "mm") ,
  # label.fill = "grey90",
  # label.buffer = unit(5, "mm")) +
    # theme_void()+

  theme_Bede_Map()+
  labs(x="Longitude",
       y="Latitude")+
  geom_label(aes(x = plot_label_Noirmoutier[1], y = plot_label_Noirmoutier[2], label = "A"), size = 15)+
  scale_x_continuous(breaks = seq(-2.30, -2.0, by = 0.10))+
  theme(plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm") ,
        legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        plot.background = element_rect(fill = "white"))
Noirmoutier_plot


ggsave("Figures/High_res/Figure1/Map_Noirmoutier.tiff",Noirmoutier_plot,width= 10, height=10)  


```

```{r Figure1 NoirmoutierV2}
#| cache: true
#| echo: false
#| eval: false
#| warning: false


masks_Noirmoutier <- "Data/shp/Figure1/Noirmoutier_masks_32630.shp"%>% 
  read_sf()

Flight_Noirmoutier <- "Data/shp/Figure1/Noirmoutier_flight_area_32630.shp"%>% 
  read_sf()

img_Noirmoutier <- rast("Data/S2_images/Noirmoutier.tiff")

sf_france <- read_sf("Data/shp/Figure1/world-administrative-boundaries.shp") %>% 
  dplyr::filter(name == "France") %>% 
  ggplot()+
  geom_sf()+
  geom_point(aes(x = -2.13494, y = 46.93734), size = 5, color = "red")+
  theme_void()

BB_img <- ggplot()+
  geom_spatraster_rgb(data = rast("Data/Pictures/Polychaete_Reef_cropped.png"), maxcell = 10e7)+
  coord_equal()+
  scale_x_continuous(expand = c(0, 0))+
  scale_y_continuous(expand = c(0, 0))+
  theme_void()

BB_segm <- data.frame(x = c(562411.2,558511,562732.1,558411),
                      y = c(5195061.5,5199150,5194521.8,5191521), 
                      group = c(1,1,2,2))
# 
# Flight_label<-data.frame(
#   Name=c(
#   "Noirmoutier Island") ,
#   Description = c("Multispectral - LiDAR"),
#   Long=c(-2.17503) ,
#   Lat=c(46.90546) 
#   )  %>% 
#   st_as_sf(coords=c("Long","Lat") )  %>% 
#   st_set_crs("EPSG:4326")  %>% 
#   st_transform(crs(masks_Noirmoutier))  %>% 
#   dplyr::mutate(lon = sf::st_coordinates(.) [,1],
#                 lat = sf::st_coordinates(.) [,2]) %>% 
#   sf::st_set_geometry(NULL)


xmin_noirm = 551000
xmax_noirm = 569800
ymin_noirm = 5191700
ymax_noirm = 5210500
  
plot_label_Noirmoutier <- data.frame(x = xmin_noirm+((xmax_noirm-xmin_noirm)*0.05),
                         y = 5210500-((5210500-ymin_noirm)*0.05)) %>%
  st_as_sf(coords=c("x","y")) %>%
  st_set_crs(crs(masks_Noirmoutier)) %>%
  st_coordinates()

thumb_France<-data.frame(x = c(xmin_noirm+((xmax_noirm-xmin_noirm)*0.8), xmin_noirm+((xmax_noirm-xmin_noirm)*1.05)),
                                   y = c(ymin_noirm+((ymax_noirm-ymin_noirm)*0.8), ymin_noirm+((ymax_noirm-ymin_noirm)*1.05))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Noirmoutier)) %>% 
  st_coordinates()

grob_img_Noirmoutier <- data.frame(x = c(xmin_noirm-((xmax_noirm-xmin_noirm)*0.01), xmin_noirm+((xmax_noirm-xmin_noirm)*0.40)),
                                   y = c(ymin_noirm-((ymax_noirm-ymin_noirm)*0.01), ymin_noirm+((ymax_noirm-ymin_noirm)*0.40))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Noirmoutier)) %>% 
  st_coordinates()

Noirmoutier_plot <-
ggplot() +
  scale_fill_manual("", labels = c("Flight area","Intertidal area", "Land area"),
                    values = c("red","#7DC27D", "#CFCFCF"))+
  geom_spatraster_rgb(data = img_Noirmoutier,max_col_value = 0.6)+
  # annotation_custom(ggplotGrob(BB_img),xmin = as.numeric(grob_img_Noirmoutier[1,1]), xmax = as.numeric(grob_img_Noirmoutier[2,1]), ymin = as.numeric(grob_img_Noirmoutier[1,2]),ymax = as.numeric(grob_img_Noirmoutier[2,2]))+
  annotation_custom(ggplotGrob(sf_france),xmin = as.numeric(thumb_France[1,1]), xmax = as.numeric(thumb_France[2,1]), ymin = as.numeric(thumb_France[1,2]),ymax = as.numeric(thumb_France[2,2]))+

  # geom_sf(data = masks_Noirmoutier, mapping = aes(fill = Type),linewidth=0.05,alpha=0.93,colour="grey30")+
  geom_sf(data = Flight_Noirmoutier, mapping = aes(fill = Type),linewidth=0.05,alpha=0.80)+
  # geom_line(data = BB_segm, aes(x = x, y=y, group = group), linewidth = 1, linetype = "dashed")+
  geom_label(aes(x = 555200, y =5204500, label = "Noirmoutier Island"), fill = "white", alpha = 0.3, size = 6)+
      coord_sf(xlim=c(xmin_noirm,xmax_noirm),
               ylim=c(5191700,ymax_noirm))+
  # ggforce::geom_mark_ellipse(data=Flight_label,
  #                aes(x=lon,
  #                    y=lat,
  #                    label = Name,
  #                    group = Name,
  #                    description=Description),
  #                size=0.3,
  #                fill = "goldenrod",
  #                con.colour = "goldenrod4",
  #                show.legend=F,
  #                label.fontsize = 25,
  #                label.hjust = 0.5,
  #                con.size = 2,
  #                label.width = 100,
  #                alpha=0.8,
  # expand = unit(2, "mm") , 
  # radius = unit(2, "mm") ,
  # label.fill = "grey90",
  # label.buffer = unit(5, "mm")) +
    # theme_void()+

  theme_Bede_Map()+
  labs(x="Longitude",
       y="Latitude")+
  geom_label(aes(x = plot_label_Noirmoutier[1], y = plot_label_Noirmoutier[2], label = "A"), size = 15)+
  scale_x_continuous(breaks = seq(-2.30, -2.0, by = 0.10))+
  theme(plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm") ,
        legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        plot.background = element_rect(fill = "white"))

a<-Noirmoutier_plot + BB_img

ggsave("Figures/High_res/Figure1/Map_Noirmoutier.tiff",a,width= 1920*2, height=1032*2, units = "px")  


```

```{r Figure1 Vigo}
#| cache: true
#| echo: false
#| eval: false
#| warning: false


masks_Vigo <- "Data/shp/Figure1/Vigo_masks_32629.shp"%>% 
  read_sf()

Flight_Vigo <- "Data/shp/Figure1/Vigo_flight_area_32629.shp"%>% 
  read_sf()

img_Vigo <- rast("Data/S2_images/Baiona.tiff")

sf_spain <- read_sf("Data/shp/Figure1/world-administrative-boundaries.shp") %>% 
  dplyr::filter(name == "Spain") %>% 
  ggplot()+
  geom_sf()+
  ylim(c(36,44))+
  xlim(c(-10,5))+
  geom_point(aes(x = -8.861720, y = 42.121207), size = 5, color = "red")+
  theme_void()

Vig_img <- ggplot()+
  geom_spatraster_rgb(data = rast("Data/Pictures/Vigo_cropped.png"))+
  coord_equal()+
  theme_void()+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=5),
        panel.spacing = unit(0, "cm"),
        plot.margin = margin(0, 0, 0, 0, "cm"))

Vigo_segm <- data.frame(x = c(511260,509800,511287,509800),
                      y = c(4663172,4663322,4663146,4661346), 
                      group = c(1,1,2,2))

# 
# Flight_label_Vigo<-data.frame(
#   Name=c(
#   "Baiona") ,
#   Description = c("Multispectral - LiDAR"),
#   Long=c(-8.862174) ,
#   Lat=c(42.121263) 
#   )  %>% 
#   st_as_sf(coords=c("Long","Lat") )  %>% 
#   st_set_crs("EPSG:4326")  %>% 
#   st_transform(crs(masks_Vigo))  %>% 
#   dplyr::mutate(lon = sf::st_coordinates(.) [,1],
#                 lat = sf::st_coordinates(.) [,2]) %>% 
#   sf::st_set_geometry(NULL)


xmin_vigo = 507877
xmax_vigo = 512679
ymin_vigo = 4661398
ymax_vigo = 4666200

plot_label_Vigo <- data.frame(x = xmin_vigo+((xmax_vigo-xmin_vigo)*0.05),
                         y = ymax_vigo-((ymax_vigo-ymin_vigo)*0.05)) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Vigo)) %>% 
  st_coordinates()

thumb_Spain<-data.frame(x = c(xmin_vigo+((xmax_vigo-xmin_vigo)*0.8), xmin_vigo+((xmax_vigo-xmin_vigo)*1.05)),
                                   y = c(ymin_vigo+((ymax_vigo-ymin_vigo)*0.8), ymin_vigo+((ymax_vigo-ymin_vigo)*1.05))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Noirmoutier)) %>% 
  st_coordinates()

grob_img_Vigo <- data.frame(x = c(xmin_vigo-((xmax_vigo-xmin_vigo)*0.01), xmin_vigo+((xmax_vigo-xmin_vigo)*0.40)),
                                   y = c(ymin_vigo-((ymax_vigo-ymin_vigo)*0.01), ymin_vigo+((ymax_vigo-ymin_vigo)*0.40))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Noirmoutier)) %>% 
  st_coordinates()

Vigo_plot <- ggplot() +
  scale_fill_manual("", labels = c("Flight area","Intertidal area", "Land area"),
                    values = c("red","#7DC27D", "#CFCFCF"))+
geom_spatraster_rgb(data = img_Vigo,maxcell = 5e+05,max_col_value = 0.6)+
  annotation_custom(ggplotGrob(Vig_img),xmin = as.numeric(grob_img_Vigo[1,1]), xmax = as.numeric(grob_img_Vigo[2,1]), ymin = as.numeric(grob_img_Vigo[1,2]),ymax = as.numeric(grob_img_Vigo[2,2]))+
  annotation_custom(ggplotGrob(sf_spain),xmin = as.numeric(thumb_Spain[1,1]), xmax = as.numeric(thumb_Spain[2,1]), ymin = as.numeric(thumb_Spain[1,2]),ymax = as.numeric(thumb_Spain[2,2]))+
  geom_sf(data = Flight_Vigo, mapping = aes(fill = Type),linewidth=0.05,alpha=0.80)+
  coord_sf(xlim=c(xmin_vigo,xmax_vigo),
               ylim=c(ymin_vigo, ymax_vigo))+
  geom_line(data = Vigo_segm, aes(x = x, y=y, color = as.factor(group), group = group), linewidth = 1, linetype = "dashed")+
  scale_color_manual(values=c("white","black"))+
  # ggforce::geom_mark_ellipse(data=Flight_label_Vigo,
  #                aes(x=lon,
  #                    y=lat,
  #                    label = Name,
  #                    group = Name,
  #                    description=Description),
  #                size=0.3,
  #                fill = "goldenrod",
  #                con.colour = "goldenrod4",
  #                show.legend=F,
  #                label.fontsize = 25,
  #                label.hjust = 0.5,
  #                con.size = 2,
  #                label.width = 100,
  #                alpha=0.8,
  # expand = unit(2, "mm") , 
  # radius = unit(2, "mm") ,
  # label.fill = "grey90",
  # label.buffer = unit(5, "mm")) +
    # theme_void()+
  theme_Bede_Map()+
  labs(x="Longitude",
       y="Latitude")+
  geom_label(aes(x = plot_label_Vigo[1], y = plot_label_Vigo[2], label = "B"), size = 15)+
  geom_label(aes(x = 512163, y =4662807, label = "Baiona"), fill = "white", alpha = 0.3, size = 6)+
  scale_x_continuous(breaks = seq(-8.9, -8.80, by = 0.02))+
  scale_y_continuous(position = "right")+

  theme(plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm") ,
        legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        plot.background = element_rect(fill = "white"))
Vigo_plot

ggsave("Figures/High_res/Figure1/Map_Vigo.tiff",Vigo_plot,width= 10, height=10)  


```

```{r Figure1 Vigo2}
#| cache: true
#| echo: false
#| eval: false
#| warning: false


masks_Vigo <- "Data/shp/Figure1/Vigo_masks_32629.shp"%>% 
  read_sf()

Flight_Vigo <- "Data/shp/Figure1/Vigo_flight_area_32629.shp"%>% 
  read_sf()

img_Vigo <- rast("Data/S2_images/Baiona.tiff")

sf_spain <- read_sf("Data/shp/Figure1/world-administrative-boundaries.shp") %>% 
  dplyr::filter(name == "Spain") %>% 
  ggplot()+
  geom_sf()+
  ylim(c(36,44))+
  xlim(c(-10,5))+
  geom_point(aes(x = -8.861720, y = 42.121207), size = 5, color = "red")+
  theme_void()

Vig_img <- ggplot()+
  geom_spatraster_rgb(data = rast("Data/Pictures/Vigo_cropped.png"), maxcell = 10e7)+
  coord_equal()+
  theme_void()+
  scale_x_continuous(expand = c(0, 0))+
  scale_y_continuous(expand = c(0, 0))+
  theme_void()

Vigo_segm <- data.frame(x = c(511260,509800,511287,509800),
                      y = c(4663172,4663322,4663146,4661346), 
                      group = c(1,1,2,2))

# 
# Flight_label_Vigo<-data.frame(
#   Name=c(
#   "Baiona") ,
#   Description = c("Multispectral - LiDAR"),
#   Long=c(-8.862174) ,
#   Lat=c(42.121263) 
#   )  %>% 
#   st_as_sf(coords=c("Long","Lat") )  %>% 
#   st_set_crs("EPSG:4326")  %>% 
#   st_transform(crs(masks_Vigo))  %>% 
#   dplyr::mutate(lon = sf::st_coordinates(.) [,1],
#                 lat = sf::st_coordinates(.) [,2]) %>% 
#   sf::st_set_geometry(NULL)


xmin_vigo = 507877
xmax_vigo = 512679
ymin_vigo = 4661398
ymax_vigo = 4666200

plot_label_Vigo <- data.frame(x = xmin_vigo+((xmax_vigo-xmin_vigo)*0.05),
                         y = ymax_vigo-((ymax_vigo-ymin_vigo)*0.05)) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Vigo)) %>% 
  st_coordinates()

thumb_Spain<-data.frame(x = c(xmin_vigo+((xmax_vigo-xmin_vigo)*0.8), xmin_vigo+((xmax_vigo-xmin_vigo)*1.05)),
                                   y = c(ymin_vigo+((ymax_vigo-ymin_vigo)*0.8), ymin_vigo+((ymax_vigo-ymin_vigo)*1.05))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Noirmoutier)) %>% 
  st_coordinates()

grob_img_Vigo <- data.frame(x = c(xmin_vigo-((xmax_vigo-xmin_vigo)*0.01), xmin_vigo+((xmax_vigo-xmin_vigo)*0.40)),
                                   y = c(ymin_vigo-((ymax_vigo-ymin_vigo)*0.01), ymin_vigo+((ymax_vigo-ymin_vigo)*0.40))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Noirmoutier)) %>% 
  st_coordinates()

Vigo_plot <- ggplot() +
  scale_fill_manual("", labels = c("Flight area","Intertidal area", "Land area"),
                    values = c("red","#7DC27D", "#CFCFCF"))+
geom_spatraster_rgb(data = img_Vigo,maxcell = 5e+05,max_col_value = 0.6)+
  # annotation_custom(ggplotGrob(Vig_img),xmin = as.numeric(grob_img_Vigo[1,1]), xmax = as.numeric(grob_img_Vigo[2,1]), ymin = as.numeric(grob_img_Vigo[1,2]),ymax = as.numeric(grob_img_Vigo[2,2]))+
  annotation_custom(ggplotGrob(sf_spain),xmin = as.numeric(thumb_Spain[1,1]), xmax = as.numeric(thumb_Spain[2,1]), ymin = as.numeric(thumb_Spain[1,2]),ymax = as.numeric(thumb_Spain[2,2]))+
  geom_sf(data = Flight_Vigo, mapping = aes(fill = Type),linewidth=0.05,alpha=0.80)+
  coord_sf(xlim=c(xmin_vigo,xmax_vigo),
               ylim=c(ymin_vigo, ymax_vigo))+
  # geom_line(data = Vigo_segm, aes(x = x, y=y, color = as.factor(group), group = group), linewidth = 1, linetype = "dashed")+
  # scale_color_manual(values=c("white","black"))+
  # ggforce::geom_mark_ellipse(data=Flight_label_Vigo,
  #                aes(x=lon,
  #                    y=lat,
  #                    label = Name,
  #                    group = Name,
  #                    description=Description),
  #                size=0.3,
  #                fill = "goldenrod",
  #                con.colour = "goldenrod4",
  #                show.legend=F,
  #                label.fontsize = 25,
  #                label.hjust = 0.5,
  #                con.size = 2,
  #                label.width = 100,
  #                alpha=0.8,
  # expand = unit(2, "mm") , 
  # radius = unit(2, "mm") ,
  # label.fill = "grey90",
  # label.buffer = unit(5, "mm")) +
    # theme_void()+
  theme_Bede_Map()+
  labs(x="Longitude",
       y="Latitude")+
  geom_label(aes(x = plot_label_Vigo[1], y = plot_label_Vigo[2], label = "B"), size = 15)+
  geom_label(aes(x = 512163, y =4662807, label = "Baiona"), fill = "white", alpha = 0.3, size = 6)+
  scale_x_continuous(breaks = seq(-8.9, -8.80, by = 0.02))+
  scale_y_continuous(position = "right")+

  theme(plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm") ,
        legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        plot.background = element_rect(fill = "white"))

b <- Vigo_plot+Vig_img

ggsave("Figures/High_res/Figure1/Map_Vigo.tiff",b,width= 1920*2, height=1032*2, units = "px")  


```

```{r Figure1 Cadiz}
#| cache: true
#| echo: false
#| eval: false
#| warning: false


masks_Cadiz <- "Data/shp/Figure1/Cadiz_masks_32629.shp"%>% 
  read_sf()

img_Cadiz <- rast("Data/S2_images/Guadalquivir.tiff")

sf_spain <- read_sf("Data/shp/Figure1/world-administrative-boundaries.shp") %>% 
  dplyr::filter(name == "Spain") %>% 
  ggplot()+
  geom_sf()+
  ylim(c(36,44))+
  xlim(c(-10,5))+
  geom_point(aes(x = -6.23469, y = 36.892621), size = 5, color = "red")+
  theme_void()

Cad_img <- ggplot()+
  geom_spatraster_rgb(data = rast("Data/Pictures/Guadalquivir_cropped.png"), maxcell = 10e7)+
  coord_equal()+
  theme_void()+
  scale_x_continuous(expand = c(0, 0))+
  scale_y_continuous(expand = c(0, 0))+
  theme_void()

# 
# Flight_label_Cadiz<-data.frame(
#   Name=c(
#   "La Esparraguera - Tarfia") ,
#   Description = c("Multispectral"),
#   Long=c(-6.231733) ,
#   Lat=c(36.894668) 
#   )  %>% 
#   st_as_sf(coords=c("Long","Lat") )  %>% 
#   st_set_crs("EPSG:4326")  %>% 
#   st_transform(crs(masks_Cadiz))  %>% 
#   dplyr::mutate(lon = sf::st_coordinates(.) [,1],
#                 lat = sf::st_coordinates(.) [,2]) %>% 
#   sf::st_set_geometry(NULL)

xmin_cadiz = 691004
xmax_cadiz = 774599
ymin_cadiz = 4033353
ymax_cadiz = 4116948
  
plot_label_cadiz <- data.frame(x = xmin_cadiz+((xmax_cadiz-xmin_cadiz)*0.05),
                         y = ymax_cadiz-((ymax_cadiz-ymin_cadiz)*0.05)) %>%
  st_as_sf(coords=c("x","y")) %>%
  st_set_crs(crs(masks_Noirmoutier)) %>%
  st_coordinates()

thumb_Cadiz<-data.frame(x = c(xmin_cadiz+((xmax_cadiz-xmin_cadiz)*0.8), xmin_cadiz+((xmax_cadiz-xmin_cadiz)*1.05)),
                                   y = c(ymin_cadiz+((ymax_cadiz-ymin_cadiz)*0.8), ymin_cadiz+((ymax_cadiz-ymin_cadiz)*1.05))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Noirmoutier)) %>% 
  st_coordinates()

grob_img_cadiz <- data.frame(x = c(xmin_cadiz-((xmax_cadiz-xmin_cadiz)*0.01), xmin_cadiz+((xmax_cadiz-xmin_cadiz)*0.40)),
                                   y = c(ymin_cadiz-((ymax_cadiz-ymin_cadiz)*0.01), ymin_cadiz+((ymax_cadiz-ymin_cadiz)*0.40))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Noirmoutier)) %>% 
  st_coordinates()

Cadiz_plot <- ggplot() +
  scale_fill_manual("", labels = c("Intertidal area", "Land area"),
                    values = c("#7DC27D", "#CFCFCF"))+
  geom_spatraster_rgb(data = img_Cadiz,maxcell = 5e+07,max_col_value = 0.6)+
  annotation_custom(ggplotGrob(sf_spain),xmin = as.numeric(thumb_Cadiz[1,1]), xmax = as.numeric(thumb_Cadiz[2,1]), ymin = as.numeric(thumb_Cadiz[1,2]),ymax = as.numeric(thumb_Cadiz[2,2]))+
  # geom_sf(data = masks_Cadiz, mapping = aes(fill = Type),linewidth=0.05,alpha=0.93,colour="grey30")+
  # geom_sf(data = Flight_Vigo, mapping = aes(fill = Type),linewidth=0.05,alpha=0.93)+
      coord_sf(xlim=c(xmin_cadiz,xmax_cadiz),
               ylim=c(ymin_cadiz,ymax_cadiz))+
  geom_point(aes(x = 746866, y = 4086773), size = 5, color = "red")+
    # theme_void()+
  theme_Bede_Map()+
  labs(x="Longitude",
       y="Latitude")+
  geom_label(aes(x = plot_label_cadiz[1], y = plot_label_cadiz[2], label = "C"), size = 15)+
  scale_x_continuous(breaks = seq(-6.9, -5.9, by = 0.4))+
  scale_y_continuous(breaks = seq(36.45, 37.25, by = 0.2))+
  theme(plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm") ,
        legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        plot.background = element_rect(fill = "white"))

c <- Cadiz_plot + Cad_img

ggsave("Figures/High_res/Figure1/Map_Cadiz.tiff",width= 1920*2, height=1032*2, units = "px")  


```

```{r Figure1 Tainaron}
#| cache: true
#| echo: false
#| eval: false
#| warning: false


masks_Tainaron <- "Data/shp/Figure1/Tainaron_masks_32634.shp"%>% 
  read_sf()

Flight_Tainaron <- "Data/shp/Figure1/Tainaron_flight_area_32634.shp"%>% 
  read_sf()

img_Tainaron <- rast("Data/S2_images/Tainaron.tiff")

sf_greece <- read_sf("Data/shp/Figure1/world-administrative-boundaries.shp") %>% 
  dplyr::filter(name == "Greece") %>% 
  ggplot()+
  geom_sf()+
  geom_point(aes(x = 22.485871, y = 36.39978), size = 5, color = "red")+
  theme_void()

Tai_img <- ggplot()+
  geom_spatraster_rgb(data = rast("Data/Pictures/Greece_cropped.png"), maxcell = 10e7)+
  coord_equal()+
  theme_void()+
  scale_x_continuous(expand = c(0, 0))+
  scale_y_continuous(expand = c(0, 0))+
  theme_void()
# Flight_label_Tainaron<-data.frame(
#   Name=c(
#   "Cape Tainaron") ,
#   Description = c("LiDAR"),
#   Long=c(22.486439) ,
#   Lat=c(36.401831) 
#   )  %>% 
#   st_as_sf(coords=c("Long","Lat") )  %>% 
#   st_set_crs("EPSG:4326")  %>% 
#   st_transform(crs(masks_Tainaron))  %>% 
#   dplyr::mutate(lon = sf::st_coordinates(.) [,1],
#                 lat = sf::st_coordinates(.) [,2]) %>% 
#   sf::st_set_geometry(NULL)
xmin_tainaron = 620943
xmax_tainaron  = 645617
ymin_tainaron  = 4027631
ymax_tainaron  = 4052305
  
plot_label_tainaron  <- data.frame(x = xmin_tainaron +((xmax_tainaron -xmin_tainaron )*0.05),
                         y = ymax_tainaron -((ymax_tainaron -ymin_tainaron )*0.05)) %>%
  st_as_sf(coords=c("x","y")) %>%
  st_set_crs(crs(masks_Tainaron)) %>%
  st_coordinates()

thumb_Tainaron<-data.frame(x = c(xmin_tainaron +((xmax_tainaron -xmin_tainaron )*0.8), xmin_tainaron +((xmax_tainaron -xmin_tainaron )*1.05)),
                                   y = c(ymin_tainaron +((ymax_tainaron -ymin_tainaron )*0.8), ymin_tainaron +((ymax_tainaron -ymin_tainaron )*1.05))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Tainaron)) %>% 
  st_coordinates()

grob_img_tainaron  <- data.frame(x = c(xmin_tainaron -((xmax_tainaron -xmin_tainaron )*0.01), xmin_tainaron +((xmax_tainaron -xmin_tainaron )*0.40)),
                                   y = c(ymin_tainaron -((ymax_tainaron -ymin_tainaron )*0.01), ymin_tainaron +((ymax_tainaron -ymin_tainaron )*0.40))) %>% 
  st_as_sf(coords=c("x","y")) %>% 
  st_set_crs(crs(masks_Tainaron)) %>% 
  st_coordinates()

Tainaron_plot <- ggplot() +
  scale_fill_manual("", labels = c("Flight area","Land area"),
                    values = c("red","#CFCFCF"))+
    geom_spatraster_rgb(data = img_Tainaron,maxcell = 5e+07,max_col_value = 0.6)+
    annotation_custom(ggplotGrob(sf_greece),xmin = as.numeric(thumb_Tainaron[1,1]), xmax = as.numeric(thumb_Tainaron[2,1]), ymin = as.numeric(thumb_Tainaron[1,2]),ymax = as.numeric(thumb_Tainaron[2,2]))+
  # geom_sf(data = masks_Tainaron, mapping = aes(fill = Type),linewidth=0.05,alpha=0.93,colour="grey30")+
  geom_sf(data = Flight_Tainaron, mapping = aes(fill = Type),linewidth=0.05,alpha=0.80)+
      coord_sf(xlim=c(xmin_tainaron,xmax_tainaron),
               ylim=c(ymin_tainaron, ymax_tainaron))+
  # ggforce::geom_mark_ellipse(data=Flight_label_Tainaron,
  #                aes(x=lon,
  #                    y=lat,
  #                    label = Name,
  #                    group = Name,
  #                    description=Description),
  #                size=0.3,
  #                fill = "goldenrod",
  #                con.colour = "goldenrod4",
  #                show.legend=F,
  #                label.fontsize = 25,
  #                label.hjust = 0.5,
  #                con.size = 2,
  #                alpha=0.8,
  # expand = unit(2, "mm") , 
  # radius = unit(2, "mm") ,
  # label.fill = "grey90",
  # label.buffer = unit(5, "mm")) +
    # theme_void()+
  theme_Bede_Map()+
  labs(x="Longitude",
       y="Latitude")+
  geom_label(aes(x = plot_label_tainaron[1], y = plot_label_tainaron[2], label = "D"), size = 20)+
  scale_x_continuous(breaks = seq(22.45, 22.52, by = 0.02))+
  theme(plot.margin = unit(c(0.1,0.1,0.1,0.1), "cm") ,
        legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_text(size = 20),
        axis.text.y = element_text(size = 20),
        plot.background = element_rect(fill = "white"))

d <- Tainaron_plot / Tai_img
ggsave("Figures/High_res/Figure1/Map_Tainaron.tiff",d,height= 1920*2, width=1032*2, units = "px")  


```

```{r Figure1 saving}
#| cache: false
#| echo: false
#| eval: false
#| warning: false

layout <- c(
  patchwork::area(t = 1, l = 1, b = 10, r = 20),
  patchwork::area(t = 11, l = 1, b = 20, r = 10),
  patchwork::area(t = 11, l = 11, b = 20, r = 20),
  patchwork::area(t = 21, l = 1, b = 30, r = 10),
  patchwork::area(t = 21, l = 11, b = 30, r = 20)
)

Tot <-  rast("Figures/High_res/Figure1/Map_Study_Site.tiff")
ext(Tot)<-c(0,2,0,1)

BB <-  rast("Figures/High_res/Figure1/Map_Noirmoutier.tiff")
ext(BB)<-c(0,1,-1,0)

BB_img<-rast("Data/Pictures/Polychaete_Reef_cropped.png")
ext(BB_img)<-c(0.70,1,-0.3,0)

Vig <-  rast("Figures/High_res/Figure1/Map_Vigo2.tif")
ext(Vig)<-c(1,2,-1,0)

Vig_img<-rast("Data/Pictures/Vigo_cropped.png")
ext(Vig_img)<-c(1.584,1.884,-0.3,0)

Cad <-  rast("Figures/High_res/Figure1/Map_Cadiz.tiff")
ext(Cad)<-c(0,1,-2,-1)

Cad_img<-rast("Data/Pictures/Guadalquivir_cropped.png")
ext(Cad_img)<-c(0.70,1,-1.925,-1.625)

Tai <- rast("Figures/High_res/Figure1/Map_Tainaron2.tiff")
ext(Tai)<-c(1,2,-2,-1)

Tai_img<-rast("Data/Pictures/Greece_cropped.png")
ext(Tai_img)<-c(1.584,1.884,-1.925,-1.625)


a<-ggplot()+
  geom_spatraster_rgb(data = Tot, maxcell= 10e+7)+
  geom_spatraster_rgb(data = BB, maxcell= 10e+7)+
  geom_spatraster_rgb(data = BB_img, maxcell= 10e+74)+
  geom_spatraster_rgb(data = Vig, maxcell= 10e+7)+
  geom_spatraster_rgb(data = Vig_img, maxcell= 10e+7)+
  geom_spatraster_rgb(data = Cad, maxcell= 10e+7)+
  geom_spatraster_rgb(data = Cad_img, maxcell= 10e+7)+
  geom_spatraster_rgb(data = Tai, maxcell= 10e+7)+
  geom_spatraster_rgb(data = Tai_img, maxcell= 10e+7)+
  coord_equal()+
  theme_void()+
  theme(axis.text = element_blank(), 
        axis.title = element_blank(), 
        axis.ticks = element_blank(), 
        axis.ticks.length = unit(0, "pt"),
        panel.grid.major=element_blank(), 
        panel.grid.minor=element_blank(), 
        plot.margin = margin(0, 0, 0, 0, "pt"))

a

ggplot2::ggsave("./Figures/High_res/Figure1/Fig1_Map_Drone_Sites.png",a, dpi = 800)

```

```{r Figure1}
#| cache: false
#| echo: false
#| warning: false
#| fig-cap: >
#|   Location of drone flights in France Spain and Greece A: Noirmoutier Island, B: Baiona, C: Guadalquivir river, D: Tainaron cape. Green represents intertidal areas. 
#| label: fig-map
#| out-width: "100%"

knitr::include_graphics("./Figures/Low_res/Figure1/Fig1_Map_Drone_Sites.png")
```

```{r Figure1_2}
#| cache: true
#| echo: false
#| eval: false
#| warning: false



```


